# ðŸ¦« Capybara VPN - Client Setup Guide

Complete guide for setting up obfuscated WireGuard VPN clients on macOS and iOS with udp2raw.

**Capybara uses udp2raw obfuscation** to disguise VPN traffic as regular HTTPS, bypassing Deep Packet Inspection (DPI) in restricted networks like China, Russia, Iran, and corporate firewalls.

---

## ðŸ“‹ Prerequisites

Before setting up a client, you need:

1. **A user account created on the VPN server:**
   ```bash
   ./capybara.py user add alice --description "Alice's device"
   ```

2. **The generated client configuration file** from `./vpn_clients/`:
   - Example: `alice_20251106_123456.conf`
   - This file contains your private key and connection details

3. **Server information:**
   - Server IP: Your VPN server's public IP
   - Obfuscated port: `443` (TCP, disguised as HTTPS)
   - VPN network: `10.7.0.0/24`

---

## ðŸŽ macOS Setup (Obfuscated Connection)

macOS supports obfuscated WireGuard connections using udp2raw, which disguises VPN traffic as HTTPS on port 443.

### Step 1: Install Requirements

```bash
# Install WireGuard command-line tools
brew install wireguard-tools

# Download udp2raw binary
cd /usr/local/bin
sudo curl -L -o udp2raw https://github.com/wangyu-/udp2raw/releases/download/20230206.0/udp2raw_amd64
sudo chmod +x udp2raw

# For Apple Silicon (M1/M2/M3), use arm64 version instead:
# sudo curl -L -o udp2raw https://github.com/wangyu-/udp2raw/releases/download/20230206.0/udp2raw_arm

# Verify installation
udp2raw --help
wg --version
```

### Step 2: Configure Client

The configuration file generated by Capybara is already set up for obfuscation. It should look like this:

**Example: `alice_20251106_123456.conf`**
```ini
[Interface]
PrivateKey = aL6+fXETtv/i01j7jBQDKtnlNXHBfTy9eE2oAcyxfWM=
Address = 10.7.0.3/24
MTU = 1280
DNS = 1.1.1.1, 8.8.8.8

# Start udp2raw client on connection
PreUp = sudo /usr/local/bin/udp2raw -c -l 127.0.0.1:4096 -r YOUR_SERVER_IP:443 -k SecureVPN2025Obfuscate --raw-mode faketcp --cipher-mode xor --auth-mode hmac_sha1 -a &
PostDown = sudo killall udp2raw

[Peer]
PublicKey = D1m+SC4pa0UDNLXcKb/+cWO1rMXgvEQYl1CZlEFD/1A=
AllowedIPs = 0.0.0.0/0
Endpoint = 127.0.0.1:4096  # Points to local udp2raw
PersistentKeepalive = 25
```

**Key components:**
- `Endpoint = 127.0.0.1:4096` - Connects to local udp2raw client
- `PreUp` - Starts udp2raw client, which forwards to server's port 443
- `PostDown` - Stops udp2raw when disconnecting
- Port 443 traffic looks like HTTPS to network inspectors

### Step 3: Grant Sudo Permissions (Required)

udp2raw requires root privileges for raw socket access:

```bash
# Edit sudoers file
sudo visudo

# Add these lines (replace 'yourusername' with your macOS username):
yourusername ALL=(ALL) NOPASSWD: /usr/local/bin/udp2raw
yourusername ALL=(ALL) NOPASSWD: /usr/bin/killall udp2raw

# Save and exit (Ctrl+X, then Y, then Enter in nano)
```

**Why needed:** udp2raw creates raw TCP packets to disguise UDP traffic, requiring root privileges.

### Step 4: Install Configuration

Copy the configuration file to WireGuard directory:

```bash
# Create WireGuard directory
sudo mkdir -p /etc/wireguard

# Copy configuration (use your actual filename)
sudo cp alice_20251106_123456.conf /etc/wireguard/alice.conf

# Set permissions
sudo chmod 600 /etc/wireguard/alice.conf
```

### Step 5: Connect

```bash
# Start the VPN tunnel
sudo wg-quick up alice

# Check status
sudo wg show

# Verify your IP changed
curl ifconfig.me

# Should show your VPN server's IP
```

### Step 6: Disconnect

```bash
# Stop the VPN tunnel
sudo wg-quick down alice
```

### Optional: Create Connection Script

For easier connection, create a script:

```bash
# Create script
cat > ~/vpn-connect.sh << 'EOF'
#!/bin/bash
sudo wg-quick up alice
echo "VPN connected!"
curl ifconfig.me
EOF

chmod +x ~/vpn-connect.sh

# Create disconnect script
cat > ~/vpn-disconnect.sh << 'EOF'
#!/bin/bash
sudo wg-quick down alice
echo "VPN disconnected!"
EOF

chmod +x ~/vpn-disconnect.sh
```

Usage:
```bash
~/vpn-connect.sh      # Connect to VPN
~/vpn-disconnect.sh   # Disconnect from VPN
```

---

## ðŸ“± iOS Setup (Workarounds Required)

**âš ï¸ Important:** iOS does **not support udp2raw** natively (requires jailbreak). You must use one of these workarounds:

### Option 1: GL.iNet Travel Router (Recommended)

Use a portable router that handles obfuscation for all your devices:

**Hardware:** GL.iNet GL-MT300N-V2 (~$20) or similar OpenWrt-compatible router

**Setup:**
1. **Install OpenWrt** on the router (usually pre-installed on GL.iNet)
2. **Install packages** via SSH:
   ```bash
   opkg update
   opkg install wireguard-tools kmod-wireguard
   # Install udp2raw from GitHub releases
   ```
3. **Configure WireGuard** on router with udp2raw
4. **Connect iOS device** to router's WiFi

**Benefits:**
- âœ… Works with any device (iPhone, iPad, Android, laptop)
- âœ… No jailbreak needed
- âœ… Portable - take it anywhere
- âœ… One-time setup
- âœ… Handles obfuscation for all connected devices

**Recommended routers:**
- GL.iNet GL-MT300N-V2 (Mango) - $20
- GL.iNet GL-AR750S-Ext (Slate) - $50
- GL.iNet GL-AXT1800 (Slate AX) - $90

### Option 2: Mac as VPN Gateway

Use your Mac as a proxy for iOS devices:

**Setup:**
1. **On Mac:** Connect to VPN using obfuscated connection (see macOS setup above)
2. **Enable Internet Sharing:**
   - Open System Preferences â†’ Sharing
   - Select "Internet Sharing"
   - Share your connection from: **WireGuard (wg0)**
   - To computers using: **Wi-Fi**
   - Click the checkbox to enable

3. **On iOS:** Connect to Mac's shared WiFi network

**Benefits:**
- âœ… No extra hardware needed
- âœ… Works immediately
- âœ… All iOS traffic goes through obfuscated VPN

**Drawbacks:**
- âŒ Mac must be on and connected
- âŒ Not portable

### Option 3: Alternative Protocols

Instead of WireGuard, use mobile-friendly obfuscation protocols:

**Shadowsocks:**
1. Install Shadowsocks server on your VPS
2. Use iOS app: Shadowrocket or QuantumultX
3. Built-in obfuscation support

**V2Ray:**
1. Install V2Ray server on your VPS
2. Use iOS app: Shadowrocket or V2RayNG
3. Multiple obfuscation methods

**Pros:**
- âœ… Native iOS support
- âœ… No extra hardware
- âœ… Good obfuscation

**Cons:**
- âŒ Different server setup (not WireGuard)
- âŒ Paid iOS apps required
- âŒ Generally slower than WireGuard

---

## ðŸ”§ Troubleshooting

### macOS Issues

#### "Operation not permitted" Error
**Problem:** udp2raw can't create raw sockets
**Solution:**
```bash
# Check System Integrity Protection
csrutil status

# Grant Full Disk Access to Terminal:
System Preferences â†’ Security & Privacy â†’ Privacy â†’ Full Disk Access
Click the lock to make changes
Add Terminal app
```

#### VPN Connects but No Internet
**Problem:** DNS not working or routing issues
**Solution:**
```bash
# Check DNS
scutil --dns | grep nameserver

# Manually set DNS if needed
sudo networksetup -setdnsservers Wi-Fi 1.1.1.1 8.8.8.8

# Check routing table
netstat -nr | grep wg

# Verify WireGuard interface
ifconfig wg0
```

#### udp2raw Process Won't Start
**Problem:** Binary not executable or wrong architecture
**Solution:**
```bash
# Check your architecture
uname -m
# x86_64 = Intel (use amd64 binary)
# arm64 = Apple Silicon (use arm binary)

# Verify binary
file /usr/local/bin/udp2raw
ls -la /usr/local/bin/udp2raw

# Re-download correct version if needed
cd /usr/local/bin
sudo rm udp2raw
# Download correct version from GitHub
```

#### Connection Drops Frequently
**Problem:** MTU size too large
**Solution:**
```ini
# In your .conf file, reduce MTU
[Interface]
MTU = 1200  # Try 1200, 1000, or even 900
```

#### Can't Start wg-quick
**Problem:** Configuration file errors
**Solution:**
```bash
# Check configuration syntax
sudo wg-quick up alice

# View detailed errors
sudo wg-quick up alice --verbose

# Verify file exists and has correct permissions
ls -la /etc/wireguard/alice.conf
```

### iOS Issues (with workarounds)

#### Travel Router Not Working
**Problem:** Router can't connect to VPN
**Solution:**
1. Check router's WireGuard configuration
2. Verify udp2raw is running on router
3. Check router's firewall rules
4. Verify port 443 is not blocked

#### Mac Internet Sharing Not Working
**Problem:** iOS device can't access internet through Mac
**Solution:**
1. Verify Mac's VPN is connected: `sudo wg show`
2. Check Internet Sharing is enabled
3. Restart Internet Sharing service
4. Forget WiFi network on iOS and reconnect

---

## ðŸ“Š Configuration File Explained

Understanding your obfuscated `.conf` file:

```ini
[Interface]
PrivateKey = aL6+fXETtv/i01j7jBQDKtnlNXHBfTy9eE2oAcyxfWM=
# Your device's private key (KEEP SECRET!)

Address = 10.7.0.3/24
# Your VPN IP address (unique per user)

MTU = 1280
# Maximum transmission unit (packet size)
# Lower = slower but more reliable through obfuscation

DNS = 1.1.1.1, 8.8.8.8
# DNS servers while connected
# 1.1.1.1 = Cloudflare (fast, private)
# 8.8.8.8 = Google (reliable)

# udp2raw obfuscation (THE KEY FEATURE!)
PreUp = sudo /usr/local/bin/udp2raw -c -l 127.0.0.1:4096 -r SERVER_IP:443 -k SecureVPN2025Obfuscate --raw-mode faketcp --cipher-mode xor --auth-mode hmac_sha1 -a &
# Starts udp2raw client in fake TCP mode on port 443
# -c = client mode
# -l = local listen address (127.0.0.1:4096)
# -r = remote server (YOUR_SERVER_IP:443)
# -k = encryption password
# --raw-mode faketcp = disguise as TCP traffic
# --cipher-mode xor = encryption method
# --auth-mode hmac_sha1 = authentication

PostDown = sudo killall udp2raw
# Stops udp2raw when disconnecting

[Peer]
PublicKey = D1m+SC4pa0UDNLXcKb/+cWO1rMXgvEQYl1CZlEFD/1A=
# Server's public key

AllowedIPs = 0.0.0.0/0
# Routes ALL traffic through VPN
# For split tunnel: 10.7.0.0/24 (VPN traffic only)

Endpoint = 127.0.0.1:4096
# Connects to LOCAL udp2raw client
# udp2raw then forwards to server's port 443

PersistentKeepalive = 25
# Sends keepalive every 25 seconds
# Maintains connection through NAT
```

---

## ðŸŽ¯ How Obfuscation Works

### Normal WireGuard (Easily Detected)
```
Your Device â†’ WireGuard UDP packets â†’ VPN Server
                   â†‘
              DPI detects & blocks
```

### Capybara with udp2raw (DPI Evasion)
```
Your Device â†’ WireGuard â†’ udp2raw â†’ Fake HTTPS/TCP â†’ VPN Server
                                              â†‘
                              DPI sees normal HTTPS traffic
```

**Port 443 = HTTPS port** - Networks allow HTTPS traffic
**Fake TCP packets** - Looks like legitimate web traffic
**Encrypted payload** - WireGuard data hidden inside

---

## ðŸ” Testing Your Connection

### Basic Connectivity Test

```bash
# Check your external IP (should be VPN server's IP)
curl ifconfig.me

# Check DNS resolution
nslookup google.com

# Test VPN gateway
ping 10.7.0.1

# Check routing
netstat -nr | grep wg
```

### Verify Obfuscation is Working

```bash
# Check udp2raw is running
ps aux | grep udp2raw

# Should see something like:
# udp2raw -c -l 127.0.0.1:4096 -r SERVER_IP:443 ...

# Monitor traffic (from another machine)
sudo tcpdump -i any port 443 -n
# Should show TCP packets on port 443 (not UDP WireGuard)
```

### Advanced Tests

```bash
# Check for DNS leaks
curl https://www.dnsleaktest.com/

# Check for IPv6 leaks
curl https://test-ipv6.com/

# Speed test
curl -o /dev/null https://speed.cloudflare.com/__down?bytes=100000000

# Latency test
ping -c 10 10.7.0.1
```

---

## ðŸŒ Country-Specific Notes

### China ðŸ‡¨ðŸ‡³
- **Status:** WireGuard blocked, obfuscation on port 443 works well
- **Recommendation:** Use Capybara with port 443 obfuscation
- **Backup:** Have travel router ready in case of protocol updates

### Russia ðŸ‡·ðŸ‡º
- **Status:** WireGuard increasingly blocked, obfuscation recommended
- **Recommendation:** Always use obfuscation
- **Note:** Consider using travel router for mobile devices

### Iran ðŸ‡®ðŸ‡·
- **Status:** Aggressive blocking, obfuscation required
- **Recommendation:** Port 443 obfuscation, be prepared to change servers
- **Backup:** Have alternative protocols ready (Shadowsocks, V2Ray)

### Corporate Networks
- **Status:** Port 443 usually allowed (required for web access)
- **Recommendation:** Obfuscation works great
- **Note:** Check company VPN policy before bypassing

---

## ðŸ“ž Getting Help

### Check VPN Status from Server

Your VPN admin can help diagnose:

```bash
./capybara.py user list --detailed
./capybara.py connection list
./capybara.py diag handshake alice
./capybara.py diag ping alice
./capybara.py logs show --service udp2raw
```

### Common Diagnostic Commands

```bash
# macOS - Check WireGuard status
sudo wg show

# macOS - Check udp2raw log
ps aux | grep udp2raw

# macOS - Restart connection
sudo wg-quick down alice
sudo wg-quick up alice

# Check server logs
./capybara.py logs tail
```

---

## ðŸ†˜ Emergency Procedures

### If VPN Stops Working

1. **Check server status:**
   ```bash
   ./capybara.py server status
   ./capybara.py health check
   ./capybara.py service status
   ```

2. **Restart on client:**
   ```bash
   # macOS
   sudo wg-quick down alice
   sudo killall udp2raw
   sudo wg-quick up alice
   ```

3. **Regenerate configuration:**
   ```bash
   ./capybara.py user remove alice
   ./capybara.py user add alice
   # Download new .conf file and reinstall
   ```

### If Obfuscation is Detected

1. **Change server port** (if supported by hosting):
   ```bash
   # Edit /etc/wireguard/wg0.conf on server
   # Change port 443 to 8443 or another common port
   ```

2. **Change obfuscation password**:
   ```bash
   # Update password in server and client configs
   ```

3. **Try different obfuscation mode**:
   ```bash
   # In udp2raw command, try:
   --raw-mode icmp  # Instead of faketcp
   ```

---

## ðŸ“š Additional Resources

### Official Documentation
- **WireGuard:** https://www.wireguard.com/
- **udp2raw:** https://github.com/wangyu-/udp2raw

### Hardware
- **GL.iNet Routers:** https://www.gl-inet.com/
- **OpenWrt:** https://openwrt.org/

### Testing Tools
- **DNS Leak Test:** https://www.dnsleaktest.com/
- **IPv6 Test:** https://test-ipv6.com/
- **Speed Test:** https://speed.cloudflare.com/

---

**ðŸ¦« Capybara VPN - Obfuscated Client Setup Complete!**

**Version:** 2.0.0
**Last Updated:** November 6, 2025
**Support:** Check main README.md or run `./capybara.py --help`
